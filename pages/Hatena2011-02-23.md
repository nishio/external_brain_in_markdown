---
title: "Hatena2011-02-23"
---

hatena

```
<body>
*1298422815*e-Tax日記(準備編)
駅から10分くらいの区役所まで歩いて行く。今の時期なので受付のお姉さんに「eTax！eTax！」と言えば適当な書類のところまで案内してくれる。間違えて「ペンタックス！ペンタックス！」と言わないこと。住基カードの新規発行と電子証明書の発行申請書を書く。番号札を貰って待つ。本人証明の書類が必要です！はい！持ってきましたよ！

- 印鑑
- 免許証(これが終わった後住所変更に行くつもりなのでマダ)
- 住民票(免許証の住所変更のために持ってた)
- 印鑑証明カード

ブブー、残念でした。印鑑は必要なく、住所変更のされていない免許証は無効で、住民票があってもダメ、あと1つだけじゃダメと言われたので保険証も提示した。

さて、ダメだと言われたのでそこから警察署まで歩いて住所変更。警察署は道をわたって少し歩いたところ。免許と保険証で無事認証完了。おばさん職員が免許証のコピーをとる機械の操作で戸惑って人を呼びに行っている…。3分くらいしてようやくコピーできた。現時点で区役所到達から19分。

「はいそれじゃ住基カード発行するんで15分くらいあちらでお待ちください」

なんだってー！

9分くらい待ったら住基カード来たけど。ここからパスワードの設定フェーズ。機械にカードを挿し込んで、クレジットカードのパスワード入力するアレみたいなものでパスワードを2回入力する。住基カードの方は数字4桁。電子証明書の方は英数字で何文字かできるらしい。手数料が5000円って言われたと思って10000円出したら9000円戻ってきた。ふー。

結局区役所到達から40分で最初のミッションは完了、と。カードリーダーは買ってあるからあとはおうちで出来るかなー

<iframe src="http://rcm-jp.amazon.co.jp/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=AAFFAA&fc1=000000&lc1=0000FF&t=nishiohirokaz-22&o=9&p=8&l=as4&m=amazon&f=ifr&asins=B00117VJ7O" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>

*1298465187*マインドマップ日記6(分散リポジトリの発展について)
今日のお話は分散リポジトリがどう発展してきたか。センターイメージも枝もないのでマインドマップと呼ぶのは正しくないけどまあこの前のgitマインドマップの続き物なので。

かつてリポジトリってのは1個だけあって、そこにコミットするものだった。黄色円筒がリポジトリ、顔が人でそのそばのはワークツリー。リポジトリとワークツリーの間でchekout/commit/updateする。

f:id:nishiohirokazu:20110223191238j:image

この時代「コミット」は二つの行動の抱合せであった。それは「変更履歴の記録」と「変更の公開」だ。複数人での共用リポジトリの場合コミット即公開であった。それが嫌ならばリポジトリをサーバにおかず自分一人で使うことになる。

「変更履歴の記録」のためには、なるべく細かい単位でコミットをした方がいい。その方が各々のチェンジセットの意味が明確になる。しかし「変更の公開」のためには、そのコミットの後でチェックアウトした人のところでビルドが通らないのでは困る。コミットする際には「きちんと動く状態への変更」というある程度大きな塊でなければならない。この二つの目的は衝突する。

ここで「手元のリポジトリ」と「公開用のリポジトリ」の2つがあればいいんじゃないの？って発想が生まれる。リポジトリとリポジトリの間のデータのやり取り(clone/push/pull)が生まれる。

f:id:nishiohirokazu:20110223191259j:image

リポジトリとリポジトリとの間でのやり取りが生まれた。こうなると、そもそも公開用のリポジトリが1個でなきゃいけない理由がないことに気づく。リポジトリが1個しかない状態では変更結果を公開するのにはその中央リポジトリへのコミット権限が必要だ。しかしいっそ各個人が自分の公開用リポジトリを持つようになれば、コミット権がなくても誰でも変更履歴を公開することが出来る。コミッターがオフィシャルのリポジトリに取り込もうと思ったらそこからpullすればいいんだ。

f:id:nishiohirokazu:20110223191307j:image

とここまでがいわゆる分散リポジトリの発展の流れだ。しかしgitにはちょっと違う視点の特徴がある。そこが他の分散リポジトリと大きく違っていて、そのせいで混乱が起きるのだと思う。

「変更履歴の記録」と「変更の公開」が切り離された。そして「変更履歴の記録」は細かい単位の方が良い。ならばうっかりワークツリー上でいろいろな変更をやってしまったとしても、それを意味的なまとまりごとに分けて整理してからコミットしたい。整理をするためには整理をするための置き場所が必要だ。「次にコミットする内容」をまとめるための一時置き場が。それがインデックスである。図では処理中の書類を入れておく書類立てをイメージした絵になっている。checkoutは緑矢印なんだけど間違えて赤で描いちゃった。

f:id:nishiohirokazu:20110223191315j:image

gitのコマンドをmercurialやsubversionのそれと対応付けようと思って混乱していたが、そもそも「コミット」という作業自体が分割されているのである。そこに気付けなかったのが混乱していた理由だった。

*1298468618*git日記
gitには4種類のオブジェクトがある。ブロブ、ツリー、コミット、タグ、の4つだ。

オブジェクトではないものがいくつかある。よく使うものはインデックスとリファレンスだ。

リファレンスにはタグ、ブランチトップ、リモートブランチトップ、そしてHEADがある。

ファイルをaddした時点で、そのファイルの内容を持ったブロブオブジェクトが作られる。ディレクトリをaddしてもツリーオブジェクトは作られない。commitした時点で作られる。

同一内容のファイルを作った場合、ブロブオブジェクトが再利用される。なぜならブロブオブジェクトにはファイル名などは入っておらずファイルの内容が同じなら同じ名前のオブジェクトになるから。

ツリーオブジェクトの中にある謎のバイナリ部分は、参照先のSHA-1ハッシュの値がhexでエンコードされずにそのまま入っているだけだった。

タグオブジェクトは tag -aとかやってアノテーション付きにした時だけ作られる。単なるタグはリファレンスだけ作られる。

このあたりのことを調べるために使ったコマンド

tree -D .git

cat .git/objects/71/abd6219437123ec763a034f2ed6296fe613d08 | python -c "import sys, zlib; print repr(zlib.decompress(sys.stdin.read()))"
</body>
<comments>
<comment>
<username>mjt</username>
<body>gitの中身を調べるにはDulwichとかlibgit2みたいな小規模なgit実装を見ると早いと思います。<br>https://github.com/jelmer/dulwich/blob/master/dulwich/objects.py#L1111<br>ほーら4種類(Commit, Tree, Tag, Blob)</body>
<timestamp>1298469518</timestamp>
</comment>
</comments>
```


[はてなダイアリー 2011-02-23](https://nishiohirokazu.hatenadiary.org/archive/2011/02/23)