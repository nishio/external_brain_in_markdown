---
title: "Hatena2009-01-31"
---

hatena

```
<body>
*1233361044*あまぞ抜き - Amazon.co.ukで安いDVDの紹介サイト -
追記: 名前がamazonで始まるのが商標的に微妙ということで<a href='http://ikunozama.appspot.com/'>イクノザマ - 海外Amazonで安いアイテムを紹介</a>になりました。
<hr>

<a href='http://amazonuki.appspot.com/'>あまぞ抜き - Amazon.co.ukで安いDVDの紹介サイト -</a>


昨日の予告通り、一晩で作れる程度のサービスを作ってリハビリをしてみた。ASINを入れると日本円付きでリストに出るってだけ。Django on GAEでviews.pyが80行、models.pyが20行、設定ファイルを1～2行書き換えて、urls.pyにマッピングを5行くらい書く、って感じ。あとHTMLの繰り返し部分を1個にまとめたくらいのサイズのテンプレートね。


安いDVDの紹介サイトって書いてあるのにCDやMacBook Proまで登録されているのはご愛嬌。まぁ、誰でも登録できるし。

*1233393861*徹夜明け
徹夜でリハビリのサービスを作って公開して帰ってきて寝て、起きたら早速壊れていた。っていうか入力を何一つバリデーションしてない！いくらなんでもこんなコードはないだろーというレベルだ。さっそく「">」なんて入力されていた。幸い実害のあるコードは埋め込まれてなかったけど。

というわけでさっそく
>|python|
    # validation
    import string
    if len(uk_asin) != 10: raise RuntimeError("Invalid ASIN")
    acceptable_letter = string.ascii_uppercase + string.digits
    if not all(c in acceptable_letter for c in uk_asin):
        raise RuntimeError("Invalid ASIN")
||<
なんてコードを書いたのでした。最初から書いとけよ自分。

*1233399693*そろそろ例のプロジェクトについて言及するか
以前、とあるシステムのソースコードを読む機会があったのだけどあまりにひどかった。あのひどいコードでまあまあまともに動いているというのが逆に信じられない。今日昼ご飯を食べながら少し話していたのだけど意外と知られていないようなので、話せる範囲でいかにひどいのか説明してみようと思う。


まず、ソースコードが大雑把に見積もって3750万行あるのだけど、その中でまともに機能しているコードは3%しかない。10分の1程度のソースコードで同程度の機能を実現しているシステムもあるのでほんとあのシステムのコードはゴミだと言っても過言じゃない(*1)


プログラマとしてはなんでそのプロジェクトはそんな状態になってしまったのか気になるところだけども、まあ多くのプロジェクト同様、真相を知る人は誰もいない。でもまあ、実際に機能しているコードのコピーみたいなものがあちこちに散らばっていることからしてコピー＆ペーストが盛んに行われていたのは間違いないと思う。それもゴミコードの40%くらいは「コピペして書き換えて新しい機能を実装」ですらない。とりあえずコピペだけして放置。全く役に立っていない。(*2)


Pythonのコードで説明すると
>|python|
def func_a(...):
    # code of A
    # code of A
    # code of A
||<
という関数があるところにコピペが行われて
>|python|
def func_a(...):
    # code of A
def func_b(...):
    # code of B
    # code of B
    # code of B
    # code of A
    # code of A
||<
こんな状態になっていたりする。func_aとか例えていえばファイルを開いたけど読まないとか、SQLクエリを作ったけど発行しないとか、そういう役に立たないコードになっている。func_bの後半にくっついているAのコードに関してはBのコードの最後でreturnしているのでそもそも呼ばれすらしなかったりする。Pythonで書かれているわけじゃないんだけどこういうレベルのクオリティって話。まともに動いているのが信じられないよね。


なんでこれで機能停止せずに動き続けているかっていうと、まあ設計者が神がかっていたというかいかれてたというかフレームワークが「モジュール内の特定の条件を満たす関数を全部呼ぶ」という設計になっていて、壊れたAのコピーがあったとしても壊れていないAのコピーが1個でも残っていれば機能が失われないからなんだ。まあ100%安心ってことはないんだけどさ。で、そういう設計なので壊れて条件を満たさなくなった関数がゴロゴロしていても平気。ウェブアプリで言えば「/add_itemにアクセスするとアイテムの追加画面が出るんだけど、実は/append_itemにアクセスすると古い今では機能しない追加画面が出る」とかいう状況。


そうそう、ソースコードのバージョン管理もひどいんだ。っていうかバージョン管理してない。リポジトリがない。コードをいじりたかったらまず適当な人にコードをコピーしてもらう。で、いじる。いじって壊れて動かなくなっちゃったらデバッグできる人がいないから丸ごと削除して、また新しくコピーを貰う。そりゃー、重要なコードのコピーがあちこちにある方が壊れにくいから引き継がれやすいよね。なんか最近では「ソースコードはほぼ同じ内容のを2コピー持つ。引き継ぐときは二人の人から1個ずつもらうこと」なんて運用で致命的なバグを入れちゃう確率を下げているらしい。(*3) その貰った二つのコードセットをマージするところでまた適当にマージするもんだから同じものを2個入れてしまうとか逆になくしてしまうとかもよくやるらしい。ある機能に関してはもともと4タイプの入力フォーマットを受け付けていたのにいつの間にか2つに減ってしまって、仕方がないので1個コピーして3つ目を作っただの、ものによっては実は4つに戻ってるだのと…。(*4)


よくこれで動いていると思うよ。誰かリファクタリングしないのかなぁ。無理か。

<hr>
参考文献

-1:「ヒトゲノムのおよそ97%は"ジャンク"であることが示されている。 これとは対照的にトラフグ(Fugu rubripes)のゲノムサイズは人間の1/10程度しかないが、ゲノムの1/3に有効な遺伝子としてコードされており、ほぼヒトと同数の遺伝子をもっていると考えられている。」<a href='http://ja.wikipedia.org/wiki/%E3%82%B8%E3%83%A3%E3%83%B3%E3%82%AFDNA'>ジャンクDNA - Wikipedia</a>
-2:「トランスポゾン (Transposon) は細胞内においてゲノム上の位置を転移 (transposition) することのできる塩基配列である。」「ゲノムプロジェクトの進行により、ヒトやマウスのゲノムにおいてタンパク質をコードする領域は 1% 以下であり、残りの 40% 以上はトランスポゾンが占めていることがわかってきた。」<a href='http://ja.wikipedia.org/wiki/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B9%E3% 83%9D%E3%82%BE%E3%83%B3'>トランスポゾン - Wikipedia</a>　「レトロトランスポゾンの転移では、DNA 配列の複製が起こる。」「LTR 型レトロトランスポゾンは、ヒトゲノムの約8% 」「ヒトゲノムは、約 500,000 の LINE を含むが、これは、ゲノム全体の 21% にあたる。」「SINE は、ヒトゲノムの 13.5% を占める。」
-3: 「ソースコードはほぼ同じ内容のを2コピー持つ。引き継ぐときは二人の人から1個ずつもらうこと」という運用: <a href='http://ja.wikipedia.org/wiki/%E6%9C%89%E6%80%A7%E7%94%9F%E6%AE%96'>有性生殖 - Wikipedia</a>のこと。
-4:「哺乳類が本来あった 4 色型色覚のうち 2 種の視物質を喪失した後に、L 錐体の特性を僅かに変えることで M 錐体を得て、一度失った 3 色型色覚を再獲得したものと考えられている。」「ヒトや近縁の霊長類は通常3種類の錐体細胞を持ち、3色型色覚であるが、 ヒトにおいては4種類の錐体細胞を持った4色型色覚の女性が生まれうる[1]。世界の女性の2～3%は4色型色覚であると発表されている[2]。だが別の研究によれば女性で50%、男性で8%もの人々が4色の光色素を持つだろうという[1]。」<a href='http://ja.wikipedia.org/wiki/%E8%89%B2'>色 - Wikipedia</a>

*1233405258*家事
- ■食料調達
--野菜ジュース2本 316
--納豆3パック 118 
--ヨーグルト6個 256
--キムチ 278
- ■ 納豆掛けご飯


やー、エネルギーを使い果たしたので今日はあんまり何もできないや。さっさと寝て速く起きるか。

*1233412910*このサイトはコンピュータに損害を与える可能性があります。
<img src="http://gyazo.com/59ccab6b88cc6bfca2a82d69bbb90116.png">
なんかすべてのリンクにこういうメッセージが出ている。「すべてのサイトはコンピュータに損害を与える可能性がある」という啓蒙活動ですね！(違います)



<img src="http://gyazo.com/206cf52a8e1f9ca365b6ca9807402a9f.png">
iPhoneも危険ですね(コラ)
</body>
<comments>
<comment>
<username>GOOGLE発狂</username>
<body>私も驚きました。BAIDUにしようかな。</body>
<timestamp>1233413621</timestamp>
</comment>
<comment>
<username>なまえ</username>
<body>まじで??(・∀・) コワレタ !!かと思いました。<br>他の方も成ってるようで安心しました。<br>gppgle暫く控えましょうか。</body>
<timestamp>1233414264</timestamp>
</comment>
<comment>
<username>tatatanta</username>
<body>よかった、自分だけじゃないのか。</body>
<timestamp>1233414266</timestamp>
</comment>
<comment>
<username>直リンで到着</username>
<body>わたしもウイルスかと思いました。<br>ビビリましたぁ～</body>
<timestamp>1233414556</timestamp>
</comment>
<comment>
<username>？？？</username>
<body>皆さんもですか。<br>変なウィルスに感染したかと・・・。<br>２０分くらい前ですかね？</body>
<timestamp>1233414627</timestamp>
</comment>
<comment>
<username>なまえ</username>
<body>ご乱心ですね・・・<br>何が起こったんでしょうか。</body>
<timestamp>1233414807</timestamp>
</comment>
<comment>
<username>zen2009</username>
<body>おかしいと思ったのは自分だけではなかったんですね。</body>
<timestamp>1233414815</timestamp>
</comment>
<comment>
<username>xig</username>
<body>はじめまして。<br>私も不思議に思い、色々調べているとこのサイトにたどり着きました。<br>走行しているうちにいつのまにか治ってるみたいです。<br>皆さんいかがでしょうか。</body>
<timestamp>1233415836</timestamp>
</comment>
<comment>
<username>bak_a_mono</username>
<body>そもそもソースコードぢゃなくて、disk dumpを適当な2人からもらってシステム再編成してるから、inodeの欠落とかもう訳わかめwwww</body>
<timestamp>1233452048</timestamp>
</comment>
<comment>
<username>bravo</username>
<body>CCFinder (http://www.ccfinder.net/ccfinderx-j.html) とかつかったなあ...</body>
<timestamp>1233500821</timestamp>
</comment>
<comment>
<username>Ouch-Ouch-Ouch</username>
<body>参考文献が遺伝子関連というところが面白いと思いました。ヒトゲノムと同様97%ジャンクのコードならば、あるコメントを突然変異（うっかり編集ミスとか）させると全く違う振る舞いをするようになって、面白いですよね。でも、もともとある目的に最適化するようにプログラムって作るモノだから、結果よりよくなることはなくて、ボロボロになるんでしょうけど。ただ、人工生命（遺伝的プログラミング）的には多様性を含むおもしろいコードだと思いますｗ</body>
<timestamp>1233532525</timestamp>
</comment>
<comment>
<username>jbking</username>
<body>Amazon Web ServiceのAPI立たいたほうがいいんじゃない？</body>
<timestamp>1233554086</timestamp>
</comment>
<comment>
<username>hituji</username>
<body>ああ、このシステムの話ぼくも聞いたことがあります。たぶん同じやつだと思う。<br>設計者って言われてる人はほんとマルチにすごい人らしいんですけど、いっつも連絡がつかなくて皆困ってるらしいですねー</body>
<timestamp>1233557058</timestamp>
</comment>
<comment>
<username>mwada</username>
<body>ある意味では永続型無計画リファクタリングプロジェクト。<br>今となっては利用者が開発者でその上オープンテスター・・・いつまでたってもベータテスト？<br>世界最大規模の人的(?)リソースを投入し続けるオバケプロジェクト。<br>そもそも何が目的のプロジェクトだったのか・・・引き継ぐこと、動き続けること自体が目的？<br>(感想：おもしろかったー!)</body>
<timestamp>1233576451</timestamp>
</comment>
<comment>
<username>nishiohirokazu</username>
<body>>いっつも連絡がつかなくて皆困ってるらしいですねー<br><br>以前、息子が代理で来てたけどあんまりデスマなんで帰っちゃいましたねー(ぇ</body>
<timestamp>1233642293</timestamp>
</comment>
</comments>
```


[はてなダイアリー 2009-01-31](https://nishiohirokazu.hatenadiary.org/archive/2009/01/31)