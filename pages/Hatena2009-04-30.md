
hatena

```
<body>
*1241059506*マスクの付け方
http://www.rakuten.co.jp/saibou/561938/829231/
<img src="http://gyazo.com/7a13684356570763a9e53002800081fd.png">
いや、違うし。
<img src="http://gyazo.com/c90046a7c9d43e53ba9ddd821ec1179a.png">
これを不自然だと思わないのか。

http://www.senshin-medical.co.jp/page5-2.html
<img src="http://gyazo.com/217c20c1e428a9e7d46dc94cb2b41814.png">
上のゴムはこうするの。

*1241075459*1時間でわからせたコンシステントハッシュで仮想ノードが必要な理由
<a href='http://www.hyuki.com/yukiwiki/wiki.cgi?ConsistentHashing'>ConsistentHashing - コンシステント・ハッシュ法</a>

とあるチャットで聞かれて図まで書いて解説したのでもったいないからエントリー化。ちなみにチャットが1時間弱だったのでこういうタイトルにした。
<img src="http://gyazo.com/8a884c285678afa6e6472d4c5ed59427.png">

>>
で、Bが消えるとBの責任範囲が全部Dに押し付けられてDがかわいそうでしょ。


Dの仕事が増えるでしょ。Cとか暇そうじゃん！サーバを複数用意しているメリットが薄れてる。みんなが同じくらい働くのが望ましい。


で、Bが1個の点で表現されているから「Bの手前」もDの1個だけで、そのせいで全部Dが引き受けるはめになった。つまり、仕事が細かく分割されてなくて1個の塊だから引き継ぐ人も1人だけで引き継いだ人涙目。あらかじめ仕事を100分割しとけばみんなで分担して肩代わりできて幸せだよね。


だからサーバが5個だけど点は5個じゃなくて500個打とう。それが仮想ノード。
<<

実装はどうするの？という質問に対して

>>
今[IP, Port]で持っているサーバのデータをたとえば[IP, Port, X](0 <= X < 100)にしてからハッシュを計算すれば、1台のサーバにつきハッシュ値が100個できるよね。


一つのサーバにつき異なるハッシュ値が100個ふられればそれでいい。実体はなくていい。あくまでコンシステントハッシュのわっかきざみの時にそうするだけ。


Xの値は保存しておく必要がないよね。アクセスに必要ないから。だからハッシュ値を計算するときに適当な値をくっつけて100個ことなるハッシュ値を作ればいいだけ。


質問:「乱数でいいの？」


乱数だと問い合わせ窓口が複数台になったときに窓口それぞれの刻み方が同じにならないから、シードを共有する必要があるね。
<<

「これがあった方が追加削除のときにいいですよ」ではなくほとんどmustだっていう話

>>
追加削除の話がわかりやすいと思ったので例にしたけど最初のハッシュ値で割り振る段階でそもそもCがさぼり気味じゃない？そしてEが働き過ぎ。


ハッシュ値で振るとランダムに振るようなもんだからばらつきが出てしまう。それを解決するためにはそもそも仮想ノードを100個くらい用意する必要がある。ほとんどmust。


資料の半ばに描いてあるグラフがあるじゃない？
>この実験から、複製を 100 から 200 用意すると妥当なバランスを実現できるといえる。 (標準偏差が平均値の 5-10% 程度になる。)


これはそういうこと
<<

<hr>

http://b.hatena.ne.jp/entry/http://d.hatena.ne.jp/nishiohirokazu/20090430/1241075459
>>
id:hitotakuchan node数が適度にあってhash関数に偏りがなければmustではない。あと仮想node数を増やすとhop数が増えるからlog2(N)(IPv4なら32個)で十分であるとDynamoの論文には書いてあった(はず)。ルーティングテーブルの管理も大変になる。
<<

スルーしようかと思ったけど勘違いする人が出るとかわいそうだからつっこんでおく。あなたが「仮想ノード」という言葉を使っているかは知らないが、少なくともこのエントリーや結城さんのページに書いてあることを理解していればここでいう「仮想ノード」をいくつ増やしたところでhop数が増えたりルーティングテーブルの管理も大変になったりしないことくらいわかるはず。

<hr>

>>
すみません。追記が入る前に修正したんですが。。。
ただルーティングテーブルのサイズは大きくなるのは確実だと思います。(これが管理が大変になるかどうかは知らない）
あと、mustであるというのもいいすぎであると思うのと、Dynamoの論文では20個程度で十分に分散しているという実験結果があったので100個というのは多すぎるんじゃないかと思いました。
<<
だからDynamoうんぬんを持ち出す前にまずここで書かれている程度のコンシステントハッシュの仕組みは理解していただかないと…。Dynamoの中でコンシステントハッシュを使っているのはさておき、Dynamoとコンシステントハッシュは「似たもの」じゃないんですよ。「ルーティングテーブルのサイズは大きくなるのは確実」などの勘違いから推測するに、脳内でDHTとかP2Pなんて単語とごたまぜになっているのではないかという感じを受けますが、すくなくともこのエントリーで解説している内容の範囲ではまだハッシュテーブルは分散していないということを理解されていますか？仮想ノードをいくら増やしたところでP2Pのノードを増やした時のような問題が起こるはずがないことを理解されていますか？

<hr>
>>
以上回答です。が、コメントで本当にいいたかったのは仮想node数の100という数字の根拠についてです。参照先のグラフにあるようにハッシュ関数としてJavaのhashCode()を利用した場合には仮想nodeの総数が1000個辺りで標準偏差が平均値の 5-10% 程度になったわけです。
だとすれば物理ノードが初めから1000個あれば仮想nodeの利用はmustではないはずです。
また参照先でも述べられているようにhashCode()関数は必ずしもよくハッシュ値を空間に分散してくれないようです。つまりよりよい関数を利用すれば仮想nodeの総数が100個辺りで同程度の分散を得られる可能性があります。その場合にも物理ノード数に応じて必要な仮想node数は変わるはずです。
つまり初心者に教える教え方として1つの物理ノードに仮想node数は100個用意するのはmustだというような教え方は良くないと思ったのです。
必要な仮想node数は利用するhash関数、用意する物理ノードなどによって変化しうると教えてあげるべきではないでしょうか？
<<

ああ、なるほど、やっと主張されている内容がわかりました。そういう意味ではmustではないです。特にRFC的な使い方のmustでは絶対にないです。編集前のチャットではそういう誤解が起こらないような流れだったのですが、わかりやすく短くする仮定で誤解を与えてしまったようですね。すみません。また「物理ノードが初めから1000個あれば」という仮定の元での議論にも感知しません。このエントリーが「ConsistentHashing - コンシステント・ハッシュ法」を呼んで「仮想ノードってなんで必要なの？」と言っている人に5個程度の物理ノードで単純に1対1にするとどういうことが起こるのかを解説した文章だという前提条件をご理解ください。

*1241076535*住民税払えっていわれた
めんどくさいから定額給付金で相殺とかしてくれないかなー(どっちもまだ手続きしていない)

*1241081914*買い出し中にノリノリになった
f:id:nishiohirokazu:20090430175831j:image

個別包装かつ保存がききそうなお菓子を買うか～と思って買っているうちにハイテンションになって条件に該当するお菓子を全部買った上に50円引きや30円引きになっているお菓子まで買ってしまった。でもまぁ100円ショップだったのでこれでも3000円くらい。

*1241090236*サンファン考察
<a href='http://www.mobius-games.co.jp/alea/SanJuan.htm'>サンファン</a>
ルールブック: http://www.mobius-games.co.jp/PDF/SanJuan_0510.pdf

Java-ja温泉でいっぱいプレイした中の一つ。カードにどんな種類があるか確認する前に始まって、1回プレイして、ルールを理解したと思ったら次のゲームに移動してしまった。もう一度プレイしたいゲーム一番手。というか多分買う。

このゲームではカードがお金でありかつ建物。建物を建てるのにはお金がいり、そのお金は手札を指定された枚数捨てることで表現される。そして誰かが12枚建物を建てるとゲーム終了で、勝利点で勝利を決めることになる。なのでまずはお金を得る手段を得て手札の回転をよくし、それから勝利点の高いカードを立てて勝利することが大まかな流れだろう。というわけで収益の期待値と勝利点について考察する。

生産施設、全42枚
1生産品の売値の期待値: インディゴ 1, 砂糖 1.4, タバコ 1.8, コーヒー 2.2, シルバー 2.6
ただしこれは「監督フェーズ」で1個生産して、「商人」フェーズで1個売却したときの期待値なので強化する建物がない序盤で「監督→商人」という順番で回ったとしてこれだけ。あわててたくさん立てても意味がない。2つめが立つとうれしくて監督とか取りたくなるかもしれないが、そうするとバッファが埋まってしまう。作物がないときに商人フェーズがきたり、空きバッファがないときに監督フェーズが来ると他人と比較してダメージを食らった状態になる。

参事会議員はカードの回転を速くしていいカードを引けるだけで+0。金鉱掘りは無条件に+1。残りの3つは微妙なバランスでみんなの状況によってよしあしが変わる。建築士は建築する場合に+1。商人は十分な商品がある場合に+1~+2.6。

鍛冶屋: コスト1 今後作るであろう生産施設が4つなら+4の価値
金鉱: コスト1 金鉱掘りフェーズに1枚取れるかもしれないカード
資料館: コスト1 参事官フェーズに持っていた手札からもいらないものが捨てられる
救貧院: コスト2 ラウンドごとに+1、ただしカードが残り少ないときだけ
闇市: コスト2 建築時商品を即座に1金と見なせる。期待値的には監督になったら+1
交易所: コスト2 商人フェーズに1枚追加で売れる。ラウンドごとに+1~+2.6、ただし十分に生産されている時だけ
井戸: コスト2 2枚生産できる生産力があればラウンドごとに+1
屋台: コスト2 2枚売れる売却力があればラウンドごとに+1
クレーン: コスト2 いらない建物を建て替えられる
礼拝堂: コスト3 ラウンドごとに-1のコストを払って勝利点+1
塔: コスト3 手札上限を増やす
水道橋: コスト3生産力+1
家具製作所: コスト3 今後立てるであろう紫の建物が4つなら+4
知事官舎: コスト3 ラウンドごと+1
マーケット: コスト4 商人フェーズに売る商品があれば+1
石切り場:コスト4 紫の建物建築ごとに+1
図書館: コスト5 いろいろチートカード

序盤はとりあえず図書館を建てることを狙えば良さそうな。まあでも図書館を引ければの話。

*1241093697*飛行機で隣の人がA型インフルエンザだったらどうなるか
<a href='http://www.asahi.com/national/update/0430/TKY200904300275.html'>asahi.com（朝日新聞社）：成田到着機にＡ型インフル患者　約２０人が空港で足止め - 社会</a>

>>
機内での簡易検査でＡ型インフルエンザと判明したことを明らかにした。新型の豚インフルエンザかどうか//結果が出るのは１日未明の予定。//機内で周囲に座っていた乗客約２０人も、念のため空港で足止めされている。 
<<

<a href='http://www.asahi.com/national/update/0429/TKY200904290158.html'>asahi.com（朝日新聞社）：鼻粘膜ぬぐい検査　豚インフルの診断手順公表　厚労省 - 社会</a>

>>
Ａ型陽性ならばＰＣＲ法という遺伝子検査で、ウイルスが同じＡ型に入る既存の香港型でないかをみる。最短で半日程度で香港型でないという結果が出ると、豚インフルの疑いが残るため、法に基づき、指定医療機関に隔離される。最終的にはウイルスを詳しく調べて豚インフルかどうかを確定する。

　空港検疫で本人が隔離された場合は、その人の家族や飛行機で長時間隣り合わせた人なども、空港周辺の宿泊施設に足止めされる。 
<<

ということなので、今「念のため空港で足止め」されている「乗客約２０人」は、午後7時半から始めた検査が最短で半日程度で終わるとして明日の朝7時半ぐらいまで空港に留め置かれるようだ。それから感染者のウイルスが「香港型でない」という結果になると、感染者は病院に隔離される。まわりの20人は空港周辺の宿泊施設に軟禁されて勝手に出歩かないように見張られるのかな。どれくらいだろう。

<a href='http://www.asahi.com/national/update/0430/TKY200904300260.html'>asahi.com（朝日新聞社）：新型インフル水際対策　成田の検疫官倍増、１６０人に - 社会</a>
>>
ウイルスの潜伏期間とされる１０日間
<<

ニュースを「潜伏期間」で検索すると10日ってのがいくつかヒットするので10日くらいは軟禁されるのかもなぁ。ゴールデンウィークに遊びに出かけて、うっかりするとゴールデンウィークよりたくさん休むはめに。隔離病棟がどんな感じなのかの体験談がどこかにないかなー。

<a href='http://mainichi.jp/select/today/news /20090501k0000m040123000c.html'>新型インフル：成田乗客「Ａ型」陽性　新型疑い例か検査 - 毎日ｊｐ(毎日新聞)</a>
>>
女性が新型インフルエンザの疑い例だった場合、この約２０人は空港近くの施設に１０日間ほどとどめ、健康状態を観察することになる見通し。
<<
お、こっちにはちゃんと10日間だと書いてある。

*1241101265*tDiaryの掃除をした
スパムだらけになって時々メモリエラーで表示できなくなっていた<a href='http://www.nishiohirokazu.org/diary/?date=200602'>西尾泰和の日記(2006-02)</a>とかをきれいにした。意外と簡単だった。tdcってファイルにコメントが書かれていてパースの簡単なフォーマットになっているのでPythonでそれっぽいコメントを全部消してやって、それからcacheディレクトリの中にあるファイルを消した。いまはtdcをreadのみにしてある。近いうちにwgetして<a href='http://www.nishiohirokazu.org/archived_coreblog/'>NISHIO HIROKAZU # Archived COREBlog</a>みたいな感じにしよう。
</body>
<comments>
<comment>
<username>hitotakuchan</username>
<body>すみません。追記が入る前に修正したんですが。。。<br>ただルーティングテーブルのサイズは大きくなるのは確実だと思います。(これが管理が大変になるかどうかは知らない）<br>あと、mustであるというのもいいすぎであると思うのと、Dynamoの論文では20個程度で十分に分散しているという実験結果があったので100個というのは多すぎるんじゃないかと思いました。</body>
<timestamp>1241085798</timestamp>
</comment>
<comment>
<username>hitotakuchan</username>
<body>何だか意図した方向とはずれてるのですが、ダイアリーはやってないのでここで申し訳ありませんが回答します。<br><br>＞だからDynamoうんぬんを持ち出す前にまずここで書かれている程度のコンシステントハッシュの仕組みは理解していただかないと…。<br><br>一応理解している。つもりです。。。<br><br>＞「ルーティングテーブルのサイズは大きくなるのは確実」などの勘違いから推測するに、<br><br>これは参照先のページのJavaのコードで言うとcircleが保持するデータが多くなるという意味です。これはmemcacheにあとからかぶせたconsistenthashなど(Katamaというやつがそうなのでしょうか)では個別のノードが個別のハッシュ空間を保持しているので問題にならないと思いますが、複数のノードで同一のハッシュ空間を共有するようなconsistenthash(Dynamoなど)を考える場合に、頻繁にchurnが発生するような状況ですべてのノードでconsistentな状態を維持するのが難しくなると思います。<br><br>＞すくなくともこのエントリーで解説している内容の範囲ではまだハッシュテーブルは分散していないということを理解されていますか？<br><br>初めのブックマークコメントでは分散していると勘違いしていましたが、すでに修正済みです。<br><br>＞仮想ノードをいくら増やしたところでP2Pのノードを増やした時のような問題が起こるはずがないことを理解されていますか？<br><br>ここでいう問題がよくわかりません。<br><br>以上回答です。が、コメントで本当にいいたかったのは仮想node数の100という数字の根拠についてです。参照先のグラフにあるようにハッシュ関数としてJavaのhashCode()を利用した場合には仮想nodeの総数が1000個辺りで標準偏差が平均値の 5-10% 程度になったわけです。<br>だとすれば物理ノードが初めから1000個あれば仮想nodeの利用はmustではないはずです。<br>また参照先でも述べられているようにhashCode()関数は必ずしもよくハッシュ値を空間に分散してくれないようです。つまりよりよい関数を利用すれば仮想nodeの総数が100個辺りで同程度の分散を得られる可能性があります。その場合にも物理ノード数に応じて必要な仮想node数は変わるはずです。<br>つまり初心者に教える教え方として1つの物理ノードに仮想node数は100個用意するのはmustだというような教え方は良くないと思ったのです。<br>必要な仮想node数は利用するhash関数、用意する物理ノードなどによって変化しうると教えてあげるべきではないでしょうか？</body>
<timestamp>1241097934</timestamp>
</comment>
<comment>
<username>earth2001y</username>
<body>源泉徴収されてないの？めんどくさいから定額給付金の手続きしていないのは同じく・・・</body>
<timestamp>1241101962</timestamp>
</comment>
</comments>
```


[はてなダイアリー 2009-04-30](https://nishiohirokazu.hatenadiary.org/archive/2009/04/30)