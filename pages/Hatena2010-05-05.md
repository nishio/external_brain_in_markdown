
hatena

```
<body>
*1273035515*&#227;だらけの文字化けはなぜ起こるか
この記事がはてなダイアリー上で化けないかどうか不安だが。

>|python|
>>> u"こんにちは世界"
u'\u3053\u3093\u306b\u3061\u306f\u4e16\u754c'
>>> u"こんにちは世界".encode("utf-8")
'\xe3\x81\x93\xe3\x82\x93\xe3\x81\xab\xe3\x81\xa1\xe3\x81\xaf\xe4\xb8\x96\xe7\x95\x8c'
>>> [unichr(ord(c)) for c in u"こんにちは世界".encode("utf-8")]
[u'\xe3', u'\x81', u'\x93', u'\xe3', ... , u'\x8c']
>>> "".join(_)
u'\xe3\x81\x93\xe3\x82\x93\xe3\x81\xab\xe3\x81\xa1\xe3\x81\xaf\xe4\xb8\x96\xe7\x95\x8c'
>>> print _
&#227;&#129;&#147;&#227;&#130;&#147;&#227;&#129;&#171;&#227;&#129;&#161;&#227;
||<

あ、やっぱダメだったか。じゃあ画像で。
<img src="http://gyazo.com/315191fb88e7cae19b03521e1662525b.png">

つまり、日本語をUTF-8でエンコードした際に1バイト目に来ることが多い\xe3周辺のコードが、ユニコード(UCS-2)ではアクセント記号のついたアルファベットに使われているから、UTF-8でエンコードしたバイト列をユニコード文字列だと誤解して使用したときや、入力されるバイト列がlatin-1でエンコードされていることを期待しているライブラリにUTF-8でエンコードしたバイト列を入れた場合などによく見られる。

>||
>>> print u"こんにちは世界".encode("utf-8").decode("latin-1")
(上と同じ文字化け)
||<

<hr>

詳しい話を聞いてみると、urllib.quoteされた文字列('%E3%83%9B%E3%82%B2'とか)をGAEのStringPropertyに入れて、それから出してurllib.unquoteしてjsonで出力しようとしたら化けた、ということらしい。

'%E3%83%9B%E3%82%B2'はアスキーの範囲に収まっているんだが、GAEはそんなこと知らないからこれを適当なエンコーディングを仮定してUnicode文字列に変換してしまう。なので取り出したときにu'%E3%83%9B%E3%82%B2'になっている。次にこれをurllib.unquoteすると、unquoteが%E3などのアスキー文字列からバイト列を作り出す関数であるにも関わらず入力がUnicode文字列なのでUnicode文字列にして返してしまう。
>|python|
>>> urllib.unquote(u'%E3%83%9B%E3%82%B2')
u'\xe3\x83\x9b\xe3\x82\xb2'
||<
UTF-8でエンコードされたバイト列が欲しかったのに、変なユニコード文字列ができてしまった。質問者はそこでstrを挟んでみたが、エラーメッセージが出たので混乱してしまった。

>|python|
>>> urllib.unquote(str(u'%E3%83%9B%E3%82%B2'))
'\xe3\x83\x9b\xe3\x82\xb2'
||<

よく読んでみると、エラーが出ていたのはこの部分ではなくjsonで出力する部分であり、エラーの内容は「UnicodeDecodeError: 'ascii' codec can't decode byte 0xe3 in position 1」であった。このエラーは「バイト列をユニコード文字列に変換したかったんでasciiコーデックを仮定して変換しようとしたけどダメだった」って言っているわけで、要するに我々は'\xe3\x83\x9b\xe3\x82\xb2'がUTF-8でエンコードされていることを知っているけど処理系は知らないので教えてやる必要があるってことだ。

>|python|
>>> '\xe3\x83\x9b\xe3\x82\xb2'.decode("utf-8")
u'\u30db\u30b2'
||<

これで万事解決。

何らかの問題に遭遇して、手当たりしだいに思いついたことを試しても解決しない状態ってのは、たいがい2つ以上の問題が重なっていて1つ解決してもゴールに近づいたことが分からないから発生するんだ。そういう場合は全体が成功したか失敗したかじゃなくて、問題を細かく分割してどこまでは成功しているのかを見るべきなんだ。

*1273055805*続・シンガポールまとめ
>>
id:KoshianX はてぶコメント読んでるとこれを日本が真似すればよくなるという主張とエアリーディングしてる人がいるなあ。「あたまいい」のは真似ることじゃないよ、考え方を適用することと真似ることは違う --- <a href='http://b.hatena.ne.jp/entry/d.hatena.ne.jp/nishiohirokazu/20100504/1272986799'>はてなブックマーク - シンガポールまとめ</a>
<<
なるほど、エアリーディングか。なんで見当違いなコメントを付けている人がたくさんいるのかなーと疑問に思っていたのだけど、勝手に「日本もシンガポールみたいに運営すればよくなる！」だとか「みんな日本を捨ててシンガポールに移住しよう！」だとかエアリーディングしていたのか。

僕はこれを連想していた:
>>
PHP使いの反論 @ Matzにっき: たとえばPHPしか知らないとしたら、PHPの欠点を指摘されると自分のやり方全体が否定されたと感じるのではないだろうか。 --- <a href='http://yugui.jp/articles/749'>1つの言語に囲い込まれるリスク - 世界線航跡蔵</a>
<<

似たような構図だなーと。

*1273068868*Re: VIPPERな俺 : 理系の用語の前に「恋の」をつけるとロマンティックがとまらない
<a href='http://blog.livedoor.jp/news23vip/archives/2640848.html'>VIPPERな俺 : 理系の用語の前に「恋の」をつけるとロマンティックがとまらない</a>

>>
恋のモホロビチッチ不連続面
<<

意味分かんないけど吹いたｗ

>>
恋の漸近線

いくら近づいても触れることは出来ないのか……
<<

かなしい

>>
恋のゼロ知識証明
<<

なんか意味深だぞ

>>
恋のランダムウォーク

ビッチだな
<<

揺れ動く乙女心。恋のブラウン運動。

>>
恋のアレニウス則:熱くなるほど指数関数的に反応が速まる

恋の熱力学第二法則:エントロピーは増大する

恋のマイスナー効果:冷えきってしまうと反発しあうしかないんだね

恋のキュリー温度:永久に引き合っているはずの磁石があっためすぎるとその性質が失われてしまう温度
<<

熱が絡むと作りやすいんだな。恋のシミュレーテッドアニーリング(徐々に冷やすことで最適解に収束することを目指す！)

>>
恋のCSMA/CD

衝突が起こった時、ランダムな時間待ってからリトライするという手順
<<

ほとぼりが冷めるまで待つわけか(笑)
</body>
<comments>
<comment>
<username>Amerikan</username>
<body>むしろ、エアリーディングよりも「北朝鮮！」とか「だったら日本の方がいい」というコメントも<br>それなりにあったと思いますが。</body>
<timestamp>1273095499</timestamp>
</comment>
</comments>
```


[はてなダイアリー 2010-05-05](https://nishiohirokazu.hatenadiary.org/archive/2010/05/05)