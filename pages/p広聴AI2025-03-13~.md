---
title: "påºƒè´AI2025-03-13~"
---

[[NEXT_PUBLIC_]]

<img src='https://scrapbox.io/api/pages/nishio/o1 Pro/icon' alt='o1 Pro.icon' height="19.5"/>
ä»¥ä¸‹ã®å†…å®¹ãŒå†åˆ©ç”¨ã—ã‚„ã™ã„çŸ¥è­˜ã¨ã—ã¦ã¾ã¨ã‚ã‚‰ã‚Œã¾ã™:
1. ### Azure OpenAI Serviceã®ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤
    - `--model-version` ã«å…·ä½“çš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·(ä¾‹: `2024-11-20`)ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
        - `--sku` ã« `Standard` ã‚„ `GlobalStandard` ã‚’æŒ‡å®šã—ã€åˆã‚ã›ã¦ `--capacity` ãªã©ã§ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’ç®¡ç†ã™ã‚‹ã€‚
    - Embeddingãƒ¢ãƒ‡ãƒ«ã‚‚åŒæ§˜ã«ã€`latest` ã¯ä½¿ãˆãšã€æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·(ä¾‹: `1`)ã‚’æŒ‡å®šã™ã‚‹ã€‚

2. ### Dockerã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å•é¡Œ
    - Apple Silicon(M1/M2)ãªã©ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã¯ã€Azureä¸Šã§å‹•ãx86_64ç”¨ã« `docker buildx build --platform linux/amd64 ...` ã®ã‚ˆã†ã«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æŒ‡å®šãŒå¿…è¦ã€‚

3. ### Key Vaultã¨ã‚¢ãƒ—ãƒªã®æ¨©é™è¨­å®š
    - Web Appã§Key Vaultã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å‚ç…§ã™ã‚‹å ´åˆã€Web Appã«ã€Œãƒãƒãƒ¼ã‚¸ãƒ‰IDã€ã‚’ä»˜ä¸ã—ã€ãã®IDã«Key Vaultã®`Key Vault Secrets User`ã‚„`Key Vault Secrets Officer`ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
        - `az webapp identity assign` ã§ãƒãƒãƒ¼ã‚¸ãƒ‰IDã‚’æœ‰åŠ¹åŒ–â†’ `az role assignment create` ã§å½“è©²IDã«ãƒ­ãƒ¼ãƒ«ä»˜ä¸â†’ Web Appã®App Settingsã« `@Microsoft.KeyVault(SecretUri=...)` ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå±•é–‹ã•ã‚Œã‚‹(ãŸã ã—ã€æ¨©é™ä¸è¶³ã‚„ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ã®å¾…ã¡æ™‚é–“ãªã©ã§å³æ™‚ã«åæ˜ ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹)ã€‚

4. ### Azure CLIå®Ÿè¡Œæ™‚ã®æ³¨æ„ç‚¹
    - CLIã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ—ãƒª(Caller appid)ãŒKey Vaultæ“ä½œã®æ¨©é™ã‚’æŒã£ã¦ã„ãªã„ã¨ãã¯ã€è¿½åŠ ã§ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ãŒå¿…è¦ã€‚
    - ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã‚„Key Vaultè¨­å®šã®éš›ã«JSONå‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã€å¾Œã‹ã‚‰å‚ç…§ã™ã‚‹ã¨ç®¡ç†ã—ã‚„ã™ã„ã€‚

5. ### App Service Planã‚„SKUã®é¸æŠ
    - é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨é€”ã§ã‚ã‚Œã°B1ãªã©ã®Basicãƒ—ãƒ©ãƒ³ãŒæ‰‹è»½ã€‚
    - è² è·ã‚’è€ƒæ…®ã—ã¦é©åˆ‡ã«é¸ã¶å¿…è¦ãŒã‚ã‚‹(æ¨™æº–ã‚„ä¸Šä½ãƒ—ãƒ©ãƒ³ã‚‚é¸æŠè‚¢)ã€‚

6. ### è¤‡æ•°Web Appã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
    - ã‚µãƒ¼ãƒç”¨ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã€ç®¡ç†ç”¨ãªã©ç”¨é€”åˆ¥ã«Web Appã‚’ä½œæˆã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚
    - èªè¨¼æƒ…å ±(ä¾‹: BASICèªè¨¼)ã¯Key Vaultã«æ ¼ç´ã—ã€ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å‚ç…§ã™ã‚‹ã¨ç®¡ç†ãŒæ¥½ã€‚

ä»¥ä¸ŠãŒAzureä¸Šã§AIã‚µãƒ¼ãƒ“ã‚¹ã‚„Webã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»é‹ç”¨ã™ã‚‹éš›ã«æ±ç”¨çš„ã«ä½¿ãˆã‚‹ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>
ã„ã‚„ãƒ¼ã€Key Vaulté–¢é€£ã§ãƒˆãƒ©ãƒ–ã‚Šã¾ãã£ã¦ã†ã¾ãã„ã‹ãªã„ã®ã§ã€ä¸€æ—¦Key Vaultãªã—ã§ã‚„ã‚‹ã“ã¨ã«æ–¹é‡è»¢æ›ã—ã‚ˆã†ã¨æ€ã†

> ãƒ“ãƒ«ãƒ‰æ™‚ã« server:latest ã§ä½œæˆã—ã¦ã„ã‚‹ã®ã«ã€ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã« client-admin:latest ã¨åˆ¥ã®ã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚Webã‚¢ãƒ—ãƒªãŒå‚ç…§ã—ã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
ç´ äººãªã®ã§ã“ã†ã„ã†ãƒŸã‚¹ã‚’ã—ãŸã‚Šã™ã‚‹

ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§console.logã—ãŸæ™‚ã«ãƒ­ã‚°ã«ã§ãªã„å•é¡Œ
- ãã‚‚ãã‚‚console.logã‚’è¿½åŠ ã—ãŸã‚‚ã®ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¦ã„ãªã„ã‚±ãƒ¼ã‚¹ã ã£ãŸ
- åˆ¥ã®è©±
    - > Azureãƒãƒ¼ã‚¿ãƒ«ã§ã€Œè¨ºæ–­ãƒ­ã‚°ã€ã‚„ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ­ã‚°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã€ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãŒååˆ†ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

2025-03-17
[ver.1](https://gist.github.com/nishio/496071fe7c1347ff7f25a10826d31db9) [ver.2](https://gist.github.com/nishio/bd2e30d604c3dad4b8aafe620fbf3635)
[åºƒè´AI (Digital Democracy 2030) ç°¡æ˜“Azureå°å…¥ã‚¬ã‚¤ãƒ‰](https://gist.github.com/nishio/605f0a9d134f7b33ba1d7a71072bcd85) (ver.3)

ã„ã£ãŸã‚“å…¨éƒ¨æ¶ˆã—ã¦ã‚„ã‚Šç›´ã—ã¦ã¿ã‚‹

`$ az login`
ãƒ†ãƒŠãƒ³ãƒˆã®ä¸­ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¦§ãŒã§ã‚‹
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã„ã„ã®ã§ã“ã®ã¾ã¾é€²ã‚ã‚‹

ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
Azure OpenAI Serviceãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ
> An existing resource with ID '...kouchou-ai-openai' has been soft-deleted. To restore the resource, you must specify 'restore' to be 'true' in the property. If you don't want to restore existing resource, please purge it first.
è¦ªåˆ‡ã™ãã‚‹w
`$ az cognitiveservices account purge --location japaneast --name kouchou-ai-openai --resource-group kouchou-ai-rg --subscription ...`

ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤
ã“ã‚Œã¯CLIã§ã§ããªã„ã®ã‹
> ä½œæˆã—ãŸAzure OpenAI Serviceãƒªã‚½ãƒ¼ã‚¹ã«ç§»å‹•ã—ã¾ã™ã€‚
![image](https://gyazo.com/bf7dd6b33c799a499866c69c0e790cd5/thumb/1000)

Azure OpenAI Studioã‚’é–‹ã‘ã¨è¨€ã£ã¦ã‚‹ã‘ã©Azure AI Foundryã§ã„ã„ã®ã‹ãªï¼Ÿ
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>
Azure OpenAI Studioã¯ã€ä»¥å‰ã¯ç‹¬ç«‹ã—ãŸãƒãƒ¼ã‚¿ãƒ«ã§ã—ãŸãŒã€ç¾åœ¨ã¯Azure AI Foundryãƒãƒ¼ã‚¿ãƒ«ã«çµ±åˆã•ã‚Œã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€ã€ŒAzure OpenAI Studioã‚’é–‹ã‘ã€ã¨æŒ‡ç¤ºã•ã‚Œã¦ã‚‚ã€Azure AI Foundryãƒãƒ¼ã‚¿ãƒ«ã§åŒã˜æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã‚‹ã®ã§ã€åŸºæœ¬çš„ã«ã¯Azure AI Foundryã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

![image](https://gyazo.com/49d83f8de9c17d6c126647a035da970d/thumb/1000)
![image](https://gyazo.com/5d6ba13f6ded5415337f3c5346f7f410/thumb/1000)

![image](https://gyazo.com/bb80ede6aa81bc37f1edbea239f0f0d9/thumb/1000)
å‰å›ã“ã‚Œã¯CLIã§ã‚„ã£ãŸæ°—ãŒã™ã‚‹ãª
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè‰²ã€…ã§ãƒˆãƒ©ãƒ–ã£ã¦ãŸã‹ã‚‰WebçµŒç”±ã‚’ãŠè–¦ã‚ã•ã‚ŒãŸã®ã‹ãª

å‰å›ä½œæ¥­ã—ãŸæ™‚ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯`https://kouchou-ai-openai.openai.azure.com`ã ã£ãŸã®ã«
ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§å¾—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯`https://japaneast.api.cognitive.microsoft.com/`ã§ã€ãªã‚“ã‹ãŠã‹ã—ã„ã­
å‰è€…ã®æ–¹ãŒæ­£ã—ã„ã‚ˆãª

.envã«åŒã˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ›¸ãã“ã¨ã«é–¢ã—ã¦
<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>embeddingã¨gpt4oã«åŒã˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ã„ã„ã®ï¼Ÿã©ã†ã‚„ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŒºåˆ¥ã™ã‚‹ã‚“ã§ã™ã‹ï¼Ÿ
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>åŒã˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
[[Azure OpenAI Service]]ã§ã¯ã€1ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è¤‡æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç†ã—ã¦ãŠã‚Šã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã€Œãƒ‡ãƒ—ãƒ­ã‚¤åã€ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã©ã®ãƒ¢ãƒ‡ãƒ«ï¼ˆgpt4oã‚„embeddingï¼‰ã‚’å‘¼ã³å‡ºã™ã‹ã‚’åŒºåˆ¥ã—ã¾ã™ã€‚


[[Azure App Service]]ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
App Service Planã®ä½œæˆ

<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>App Serviceã‚’3ã¤ç«‹ã¡ä¸Šã’ã‚‹ã‘ã©ã€è²»ç”¨ã¯ã©ã†ãªã‚Šã¾ã™ï¼Ÿ3å€ï¼Ÿ
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>App Serviceã®æ–™é‡‘ã¯ã€å€‹ã€…ã®ã‚¢ãƒ—ãƒªã®æ–™é‡‘ã§ã¯ãªãã€App Service Planå˜ä½ã§ç™ºç”Ÿã—ã¾ã™ã€‚
ã¤ã¾ã‚Šã€åŒã˜ãƒ—ãƒ©ãƒ³å†…ã«3ã¤ã®ã‚¢ãƒ—ãƒªã‚’é…ç½®ã™ã‚Œã°ã€å¿…ãšã—ã‚‚è²»ç”¨ãŒ3å€ã«ãªã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€å„ã‚¢ãƒ—ãƒªã‚’åˆ¥ã€…ã®ãƒ—ãƒ©ãƒ³ã§ç«‹ã¡ä¸Šã’ã‚‹ã¨ã€ãã®åˆ†æ–™é‡‘ãŒã‹ã•ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>AWSã§ã„ã†ã¨ä¸€ã¤ã®EC2ã®ä¸­ã§3ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå‹•ã„ã¦ã‚‹æ„Ÿã˜ã§ã™ã‹ï¼Ÿ
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>ã¯ã„ã€ãã®é€šã‚Šã§ã™ã€‚
åŒã˜App Service Planå†…ã«é…ç½®ã™ã‚‹ã¨ã€1å°ã®EC2ä¸Šã§è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å‹•ã‹ã™ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã€åˆ¥ã€…ã®ãƒ—ãƒ©ãƒ³ã‚’ä½¿ã‚ãªã‘ã‚Œã°è²»ç”¨ã¯å¢—ãˆã¾ã›ã‚“ã€‚

ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤
ã“ã“ã‹ã‚‰ãƒ“ãƒ«ãƒ‰å¾…ã¡ãŒã‚ã‚‹ã®ã§3ã¤ä¸¦åˆ—ã§ã‚„ã‚ã†ã¨æ€ã†
> ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³
ã“ã“å¤ã„åå‰ãªã®ã§ç›´ã™å¿…è¦ãŒã‚ã‚‹

`$ docker buildx build --platform linux/amd64 -t kouchou-ai-server:latest ./server`

> ãƒ“ãƒ«ãƒ‰ã—ãŸDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™

å‰å›ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«ã¯ã“ã‚Œã¯ãªã‹ã£ãŸã­ã€è¦ªåˆ‡ã«ãªã£ãŸ
> WARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested
ãã‚Šã‚ƒãã†ã 
> pydantic_core._pydantic_core.ValidationError: 2 validation errors for Settings
>  ADMIN_API_KEY
>  PUBLIC_API_KEY
ãã‚Šã‚ƒãã†ã 
ã“ã®ãƒ†ã‚¹ãƒˆã¯é€†åŠ¹æœã w

Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¿å­˜ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

:

```
# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’tarãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
docker save kouchou-ai-server:latest -o kouchou-ai-server.tar

# tarãƒ•ã‚¡ã‚¤ãƒ«ã‚’gzipã§åœ§ç¸®
gzip kouchou-ai-server.tar
```

Azure Container RegistryãŒãªã„ã¨docker pushãŒã§ããªã„ã®ã‹...


Azure App Serviceã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
:

```
# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
az webapp config container set \
  --resource-group kouchou-ai-rg \
  --name kouchou-ai-server \
  --multicontainer-config-type compose \
  --multicontainer-config-file docker-compose.yml
```

docker-compose.ymlã‚’æ–°ã—ãä½œã‚‹ã¿ãŸã„ãªã“ã¨ã‚’è¨€ã£ã¦ã‚‹ã‘ã©é•ã†ã‚ˆã­
å‰å›ãªã‚“ã¦è¨€ã£ã¦ãŸï¼Ÿ
[https://gist.github.com/nishio/bd2e30d604c3dad4b8aafe620fbf3635#2-web-appã®ä½œæˆã‚µãƒ¼ãƒãƒ¼ç”¨](https://gist.github.com/nishio/bd2e30d604c3dad4b8aafe620fbf3635#2-web-appã®ä½œæˆã‚µãƒ¼ãƒãƒ¼ç”¨)
:

```
# ã‚µãƒ¼ãƒãƒ¼ç”¨Web Appã®ä½œæˆ
az webapp create \
  --resource-group kouchou-ai-rg \
  --plan kouchou-ai-plan \
  --name kouchou-ai-server \
  --deployment-container-image-name kouchouaiacr.azurecr.io/server:latest
```

ãã‚‚ãã‚‚å‰å›ã¯Azure Container Registryã‚’ä½œã£ã¦ãŸã®ã‹

<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>ã™ã§ã«ãƒ­ãƒ¼ã‚«ãƒ«ã§ç«‹ã¡ä¸Šã’ã‚‹æ™‚ã‚ˆã†ã«compose.yamlãŒã‚ã‚‹ã‘ã©ãã‚Œã§ã„ã„ã®ã‹ãªï¼Ÿ
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>åŸºæœ¬çš„ã«ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã®compose.yamlã‚’åˆ©ç”¨ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€Azure App Serviceã§é‹ç”¨ã™ã‚‹éš›ã¯ä»¥ä¸‹ã®ç‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
- ãƒ•ã‚¡ã‚¤ãƒ«åï¼šAzureã§ã¯é€šå¸¸ã€Œdocker-compose.ymlã€ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹ãŸã‚ã€å¿…è¦ãªã‚‰ãƒªãƒãƒ¼ãƒ ã—ã¦ãã ã•ã„ã€‚
- ç’°å¢ƒå¤‰æ•°ãƒ»ãƒãƒ¼ãƒˆè¨­å®šï¼šæœ¬ç•ªç’°å¢ƒç”¨ã«é©åˆ‡ãªè¨­å®šãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
é©å®œèª¿æ•´ã™ã‚Œã°ã€ãã®ã¾ã¾ä½¿ã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>å‰å›ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã¯ãã†ã„ã†ã“ã¨ã¯ã—ã¦ã„ãªã„ã®ã ã‘ã©ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ã«ã“ã†ãªã£ãŸã®ã‹ãªï¼Ÿ
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>ãã†ã§ã™ã€‚å‰å›ã¯å€‹ã€…ã®è¨­å®šã‚’åˆ¥ã€…ã«è¡Œã£ã¦ã„ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä»Šå›ã¯docker-composeã‚’ä½¿ã†ã“ã¨ã§è¨­å®šã‚’ä¸€å…ƒç®¡ç†ã—ã€ã‚·ãƒ³ãƒ—ãƒ«ã«é‹ç”¨ã§ãã‚‹ã‚ˆã†ã«å·¥å¤«ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒ›ãƒ³ãƒˆã‹ãªãã€ã¾ã‚ã„ã„ã‘ã©

renameã®å¿…è¦æ€§ã«ã¤ã„ã¦ã‚»ã‚«ãƒ³ãƒ‰ã‚ªãƒ”ãƒ‹ã‚ªãƒ³
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Œdocker-compose.ymlã€ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§èªè­˜ã•ã‚Œã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã€Œcompose.yamlã€ã¨ã—ã¦ã„ã‚‹å ´åˆã¯ãƒªãƒãƒ¼ãƒ ã™ã‚‹ã®ãŒç„¡é›£ã§ã™ã€‚
ã©ã†ã—ã¦ã‚‚ã€Œcompose.yamlã€ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€Azure CLI ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼š--multicontainer-config-fileï¼‰ã§æ˜ç¤ºçš„ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã†ã„ã†æ„Ÿã˜ãªã‚‰ã€æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã‹ã‚‰renameã—ãªãã¦ã„ã„ã‹
:

```
# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
az webapp config container set \
  --resource-group kouchou-ai-rg \
  --name kouchou-ai-server \
  --multicontainer-config-type compose \
  --multicontainer-config-file compose.yaml
```


<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>ã“ã®CLIå´ã®æ‰‹é †ã§ã¯imageã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒãªã„ã‚ˆã†ãªæ°—ãŒã™ã‚‹
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>CLIã®æ‰‹é †ã§ã¯ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸è‡ªä½“ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆpushï¼‰ã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚
é€šå¸¸ã¯ã€Docker Hubã‚„Azure Container Registryãªã©ã®å¤–éƒ¨ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«äº‹å‰ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã€CLIã¯ãã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªä¸Šã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦App Serviceã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>ä»Šå›Azure Container Registryã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼Ÿã‚’ä½œã£ã¦ã„ãªã„
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>ãã†ã§ã™ã€‚ä»Šå›ã®ã‚¬ã‚¤ãƒ‰ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆã‚’é‡è¦–ã—ã¦ãŠã‚Šã€ACRã‚’åˆ©ç”¨ã›ãšã«ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ãƒ»ä¿å­˜ã—ãŸDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ–¹æ³•ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
<img src='https://scrapbox.io/api/pages/nishio/nishio/icon' alt='nishio.icon' height="19.5"/>CLIã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ï¼Ÿãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã—ã‹ã§ããªã„ï¼Ÿ
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>
CLIã§ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ©Ÿèƒ½ã¯åŸºæœ¬çš„ã«æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
é€šå¸¸ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªï¼ˆACRã‚„Docker Hubãªã©ï¼‰ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã€ãã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’App Serviceã‹ã‚‰å‚ç…§ã™ã‚‹ã‹ã€ã‚‚ã—ãã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®Deployment Centerã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚


ã†ãˆãƒ¼ã€ã‚ã‚“ã©ãã•ã€‚ACRä½œæˆã¯ãã‚“ãªã«ã¤ã¾ã¥ã„ã¦ãªã„ã‹ã‚‰å…¥ã‚Œã¦ã‚‚ã„ã„ã‹ã‚‚ãª

![image](https://gyazo.com/96583ca24af835e4d49b4051b38ab334/thumb/1000)
GitHub Actionsã§å·®ã—è¾¼ã‚€ã“ã¨ãŒãŠè–¦ã‚ã•ã‚Œã¦ã‚‹
ã˜ã‚ƒã‚ã‚ã‚Œã‹ã€ä»Šæ‰‹å…ƒã§docker buildxã—ã¦ã‚‹ã‘ã©ã€å°†æ¥çš„ã«ã¯GitHub Actionsã§ã‚„ã‚‹ã®ãŒã„ã„ã®ã‹ï¼Ÿ

![image](https://gyazo.com/39ab4e6e9c2904e67be0dccd2a5e486f/thumb/1000)
ã„ã‚„GitHub Actionsã§ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚‚ã€ãã‚Œã¯çµå±€ACRã‹Docker Hubã‹ã«pushã—ã¦ã€ãã®ãƒˆãƒªã‚¬ãƒ¼ã§pullã™ã‚‹ã£ã¦ã ã‘ã‹ã€‚ã˜ã‚ƒã‚ACRã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ–¹ãŒã„ã„ãªã€‚

<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>
Azure App Serviceã¸ã¯ç›´æ¥ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªã„ãŸã‚ã€ä¸€èˆ¬çš„ã«ã¯ACRï¼ˆAzure Container Registryï¼‰ã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚
ä»¥ä¸‹ãŒç°¡å˜ãªæ‰‹é †ã§ã™ï¼š

1. ### ACRã®ä½œæˆ
- `$ az acr create --resource-group kouchou-ai-rg --name aikouchouacr --sku Basic`

2. ### ACRã«ãƒ­ã‚°ã‚¤ãƒ³
- `$ az acr login --name aikouchouacr`

3. ### Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ã‚¿ã‚°ä»˜ã‘
- `$ docker buildx build --platform linux/amd64 -t kouchou-ai-server:latest ./server`

- `$ docker tag kouchou-ai-server:latest aikouchouacr.azurecr.io/kouchou-ai-server:latest`

4. ### ACRã¸ãƒ—ãƒƒã‚·ãƒ¥
- `$ docker push aikouchouacr.azurecr.io/kouchou-ai-server:latest`

5. ### App Serviceã®è¨­å®š
- Azure Portalã®ã€Œã‚³ãƒ³ãƒ†ãƒŠè¨­å®šã€ã§ã€ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ACRã‚’é¸ã³ã€ãƒªãƒã‚¸ãƒˆãƒªåã¨ã‚¿ã‚°ã‚’æŒ‡å®šã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ACRã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦App Serviceã§ã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`$ az acr update -n aikouchouacr --admin-enabled true`
`$ az acr credential show --name aikouchouacr --resource-group kouchou-ai-rg`

:

```
az webapp config container set \
  --resource-group kouchou-ai-rg \
  --name kouchou-ai-server \
  --docker-custom-image-name aikouchouacr.azurecr.io/kouchou-ai-server:latest \
  --docker-registry-server-url https://aikouchouacr.azurecr.io \
  --docker-registry-server-user <ACRãƒ¦ãƒ¼ã‚¶ãƒ¼å> \
  --docker-registry-server-password <ACRãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰>
```


å†èµ·å‹•ã™ã‚‹
`$ az webapp restart --resource-group kouchou-ai-rg --name kouchou-ai-server`

ã‚µãƒ¼ãƒãŒèµ·å‹•ã—ãŸã‹ã©ã†ã‹ã¯ãƒ­ã‚°ã‚’ã¿ã‚ˆã†
:

```
# App Serviceã®ãƒ­ã‚°ã‚’ç¢ºèª
az webapp log tail \
  --resource-group kouchou-ai-rg \
  --name kouchou-ai-server
```


ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„ãªã€‚

-----

`% # ACRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³`
az acr login --name kouchouaiacr
zsh: command not found: #
Could not connect to the registry login server 'kouchouaiacr.azurecr.io'. Please verify that the registry exists and the URL '[https://kouchouaiacr.azurecr.io/v2/'](https://kouchouaiacr.azurecr.io/v2/') is reachable from your environment.
Try running 'az acr check-health -n kouchouaiacr --yes' to diagnose this issue.

- `% az acr check-health -n kouchouaiacr --yes`
Docker daemon status: available
Docker version: 'Docker version 20.10.22, build 42c8b31, platform linux/arm64'
Docker pull of 'mcr.microsoft.com/mcr/hello-world:latest' : OK
Azure CLI version: 2.70.0
2025-03-17 08:23:50.591717 An error occurred: CONNECTIVITY_DNS_ERROR
Failed to reach DNS for registry 'kouchouaiacr.azurecr.io'. Please check if the spelling is correct, if the CLI environment is on correct cloud and your network connectivity.

ACRãŒäºŒã¤ã‚ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã™ã‚‹ï¼Ÿä¸å¯è§£

---
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>
Azure CLI ã§ã¯
--docker-custom-image-name â†’ --container-image-name
--docker-registry-server-url â†’ --container-registry-url
--docker-registry-server-user â†’ --container-registry-user
--docker-registry-server-password â†’ --container-registry-password
ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»Šå¾Œã¯æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

---
ãƒ­ã‚°ãŒå‡ºãªã„å•é¡Œã€ã‚€ã—ã‚Azure Portalã®ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ ãªã‚‰ã¤ãªãŒã‚‹ã“ã¨ã‚‚ã‚ã‚‹
- ã¤ãªãŒã‚‰ãªã„ã“ã¨ã‚‚ã‚ã‚‹

admin

```
2025-03-17T08:52:06  Welcome, you are now connected to log-streaming service.Starting Log Tail -n 10 of existing logs ----/appsvctmp/volatile/logs/runtime/container.log
2025-03-17T08:51:15.3231533Z Configure Services : 08.51.15.322864
2025-03-17T08:51:16.7442581Z Configure : 08.51.16.743970
2025-03-17T08:51:17.6208151Z Setting Up Routes : 08.51.17.620555
2025-03-17T08:51:18.2362864Z Exiting Configure : 08.51.18.236021
2025-03-17T08:51:18.6132403Z [40m[1m[33mwarn[39m[22m[49m: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[35]
2025-03-17T08:51:18.6133451Z       No XML encryptor configured. Key {fdf3c2ce-05ea-4c38-a6ba-9cffe3df9d1b} may be persisted to storage in unencrypted form.
2025-03-17T08:51:18.8348701Z Hosting environment: Production
2025-03-17T08:51:18.8359212Z Content root path: /opt/Kudu
2025-03-17T08:51:18.8533469Z Now listening on: http://0.0.0.0:8181
2025-03-17T08:51:18.8534039Z Application started. Press Ctrl+C to shut down.Ending Log Tail of existing logs ---Starting Live Log Stream ---
2025-03-17T08:53:06  No new trace in the past 1 min(s).
2025-03-17T08:53:50.5848228Z
2025-03-17T08:53:50.7628783Z > kouchou-ai-client-admin@0.1.0 start
2025-03-17T08:53:50.7629743Z > next start -p 4000
2025-03-17T08:53:50.7629784Z
2025-03-17T08:53:54.5458289Z    â–² Next.js 15.1.6
2025-03-17T08:53:54.5460079Z    - Local:        http://localhost:4000
2025-03-17T08:53:54.5460176Z    - Network:      http://169.254.132.3:4000
2025-03-17T08:53:54.5460215Z
2025-03-17T08:53:54.5460243Z  âœ“ Starting...
2025-03-17T08:53:56.3796807Z  âœ“ Ready in 3.9s
2025-03-17T08:55:06  No new trace in the past 1 min(s).
```


client

```
2025-03-17T08:48:53  Welcome, you are now connected to log-streaming service.Starting Log Tail -n 10 of existing logs ----/home/LogFiles/__lastCheckTime.txt  (https://kouchou-ai-client.scm.azurewebsites.net/api/vfs/LogFiles/__lastCheckTime.txt)03/17/2025 08:47:13/home/LogFiles/kudu/trace/c2a2216e2cb4-c522ab4a-31c3-44b4-8dae-bd0dd87d61cf.txt  (https://kouchou-ai-client.scm.azurewebsites.net/api/vfs/LogFiles/kudu/trace/c2a2216e2cb4-c522ab4a-31c3-44b4-8dae-bd0dd87d61cf.txt)
2025-03-17T08:48:52  Startup Request, url: /api/logstream/, method: GET, type: request, pid: 776,1,5, ScmType: None/home/LogFiles/2025_03_17_lw1sdlwk000C43_default_docker.log  (https://kouchou-ai-client.scm.azurewebsites.net/api/vfs/LogFiles/2025_03_17_lw1sdlwk000C43_default_docker.log)
2025-03-17T08:44:56.888979144Z
2025-03-17T08:44:56.889594374Z > kouchou-ai-client@0.1.0 build
2025-03-17T08:44:56.889598946Z > next build
2025-03-17T08:44:56.889601478Z
2025-03-17T08:45:09.723432943Z    ??? Next.js 15.1.6
2025-03-17T08:45:09.743210166Z
2025-03-17T08:45:09.834319984Z    Creating an optimized production build .../home/LogFiles/2025_03_17_lw1sdlwk000C43_docker.log  (https://kouchou-ai-client.scm.azurewebsites.net/api/vfs/LogFiles/2025_03_17_lw1sdlwk000C43_docker.log)
2025-03-17T08:46:31.303Z INFO  - Waiting for response to warmup request for container kouchou-ai-client_0_4abf5642. Elapsed time = 100.3545987 sec
2025-03-17T08:46:48.895Z INFO  - Waiting for response to warmup request for container kouchou-ai-client_0_4abf5642. Elapsed time = 117.9464186 sec
2025-03-17T08:47:05.550Z INFO  - Waiting for response to warmup request for container kouchou-ai-client_0_4abf5642. Elapsed time = 134.6007097 sec
2025-03-17T08:47:27.022Z INFO  - Waiting for response to warmup request for container kouchou-ai-client_0_4abf5642. Elapsed time = 156.0733663 sec
2025-03-17T08:47:49.023Z INFO  - Waiting for response to warmup request for container kouchou-ai-client_0_4abf5642. Elapsed time = 178.0737392 sec
2025-03-17T08:48:14.332Z INFO  - Waiting for response to warmup request for container kouchou-ai-client_0_4abf5642. Elapsed time = 203.3826478 sec
2025-03-17T08:48:31.846Z INFO  - Waiting for response to warmup request for container kouchou-ai-client_0_4abf5642. Elapsed time = 220.8968595 sec
2025-03-17T08:48:42.925Z ERROR - Container kouchou-ai-client_0_4abf5642 for site kouchou-ai-client did not start within expected time limit. Elapsed time = 231.948246 sec
2025-03-17T08:48:43.097Z ERROR - Container kouchou-ai-client_0_4abf5642 didn't respond to HTTP pings on port: 3000, failing site start. See container logs for debugging.
2025-03-17T08:48:43.347Z INFO  - Stopping site kouchou-ai-client because it failed during startup.Ending Log Tail of existing logs ---Starting Live Log Stream ---
2025-03-17T08:49:54  No new trace in the past 1 min(s).
```


serverãŒã‚¨ãƒ©ãƒ¼
![image](https://gyazo.com/1e278d66dc93bac3ceb5864aac73fa8b/thumb/1000)

[https://gist.github.com/nishio/7745a8449c0688976db9aebfb5aa398e](https://gist.github.com/nishio/7745a8449c0688976db9aebfb5aa398e)
<img src='https://scrapbox.io/api/pages/nishio/o3/icon' alt='o3.icon' height="19.5"/>
ãƒ­ã‚°ã‹ã‚‰è¦‹ã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•æ™‚ã«å¿…è¦ãªè¨­å®šæƒ…å ±ï¼ˆç‰¹ã«ã€ADMIN_API_KEYã€PUBLIC_API_KEYã€OPENAI_API_KEY ãªã©ï¼‰ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ Pydantic ã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ãã®çµæœã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãèµ·å‹•ã§ããšã€HTTP ã® ping ã«ã‚‚å¿œç­”ã§ããšã€æœ€çµ‚çš„ã«èµ·å‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

ã€å¯¾ç­–ã€‘

å¿…é ˆç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•æ™‚ã«å¿…è¦ã¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°ï¼ˆADMIN_API_KEYã€PUBLIC_API_KEYã€OPENAI_API_KEY ãªã©ï¼‰ã‚’ã€Azure App Service ã®ã€Œæ§‹æˆã€â†’ã€Œã‚¢ãƒ—ãƒªè¨­å®šã€ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚

:

```
az webapp config appsettings set \
 --resource-group kouchou-ai-rg \
 --name kouchou-ai-server \
 --settings ADMIN_API_KEY="admin" PUBLIC_API_KEY="public" OPENAI_API_KEY="..."
```


å¤šåˆ†ã“ã‚Œãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§USE_AZUREã®ã¨ãã«ã¯ãªãã¦ã‚‚OKã«ã™ã‚‹ã¨ã‹ã—ãŸæ–¹ãŒã„ã„ã®ã‹ã‚‚

[[zshã§#ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«ã™ã‚‹]]

ãªã‚“ã‹è‰²ã€…ã‚¨ãƒ©ãƒ¼ã®ã‚ˆã†ãªã‚‚ã®ãŒå‡ºãŸã‚Šã—ã¦ãŸã‘ã©ä»–ã®ä½œæ¥­ã‚’ã—ã¦ã„ã‚‹ã†ã¡ã«æ°—ãŒã¤ã„ãŸã‚‰å®Œäº†ã—ã¦ã„ãŸ
[https://gist.github.com/nishio/df0513d9ac5219e848390315d08d03fe](https://gist.github.com/nishio/df0513d9ac5219e848390315d08d03fe)

![image](https://gyazo.com/9ce8d8e5e3545db739919950fde501ef/thumb/1000)
ãŠã£ã€å‡¦ç†ãŒå§‹ã¾ã£ãŸã£ã½ã„ã

å•é¡Œã¯ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãŒã¡ã‚ƒã‚“ã¨é€²ã‚“ã§ã„ã‚‹ã®ã‹ã€è£ã§ã‚¨ãƒ©ãƒ¼ã§è½ã¡ã¦ã‚‹ã®ã‹ã€ã¨ã„ã†ã¨ã“ã‚ã ãª
ã‚ã¨clientã¯ã¾ã è¡¨ç¤ºã•ã‚Œãªã„

ä»Šæ—¥ã®é€²æ—
- ä¸€æ—¦ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¶ˆã—ã¦ã‚„ã‚Šç›´ã—
- Key Vaultã‚’ä½¿ã‚ãªã„è·¯ç·šã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(ver.3)ã‚’ç”Ÿæˆã—ã¦ãã‚Œã«å¾“ã†
- Azure Container Registryã‚‚ä½¿ã‚ãªã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã ã£ãŸãŒã€ãã‚Œã¯ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œãŒå¿…é ˆã«ãªã£ã¦æ‰‹é–“ãªã®ã§ACRã¯ä½¿ã†ã“ã¨ã«ã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†ç”Ÿæˆã—ãŸ
- ç®¡ç†ç”»é¢ã‹ã‚‰CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å‡¦ç†é–‹å§‹ã™ã‚‹ã“ã¨ã¯ã§ããŸã€‚ãŸã ã—ååˆ†ãªæ™‚é–“ãŒçµŒã£ã¦ã‚‚å®Œäº†ã—ãªã„ã®ã§ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ã§æ­»ã‚“ã§ã‚‹ã®ã ã¨æ€ã†ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡ºã™ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æµã‚Œãªã„ã‚ˆã†ãªã®ã§åŸå› ã¯ä¸æ˜ã€‚
- clientã¯ã¾ã èµ·å‹•ã—ãªã„ã€‚å¤šåˆ†serverã«æ¥ç¶šã™ã‚‹ã®ã«Azure App Serviceã®ä¸­ã§ã¯localhostã‚’é€šã—ãŸé€šä¿¡ãŒã§ããªã„ã®ã ã¨æ€ã†

2025-03-18
Azureç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã¨Azure OpenAI Serviceã‚’ä½¿ã†ã®ã¯ç‹¬ç«‹ã®è©±ã ã‚ˆã­ã¨ã„ã†è©±
ç¢ºã‹ã«ãã‚Œã¯ãã†
ã¡ã‚‡ã†ã©ãƒªãƒã‚¸ãƒˆãƒªã‚‚è‰²ã€…å¤‰ã‚ã£ãŸã“ã¨ã ã—ãƒªãƒã‚¸ãƒˆãƒªã”ã¨ã‚¼ãƒ­ã‹ã‚‰ã‚„ã£ã¦ã¿ã‚‹ã‹

[https://github.com/digitaldemocracy2030/kouchou-ai](https://github.com/digitaldemocracy2030/kouchou-ai)
fork
[https://github.com/nishio/kouchou-ai](https://github.com/nishio/kouchou-ai)
cloneã—ã¦.envã«OpenAIã®APIã‚­ãƒ¼ã‚’ã„ã‚Œã¦docker-compose up

> Attaching to kouchou-ai-api-1, kouchou-ai-client-1, kouchou-ai-client-admin-1
>  Error response from daemon: driver failed programming external connectivity on endpoint kouchou-ai-api-1 (0ad5b0eeabca84ef698349ed3093339034298f7711c03d847781b61a2b7a55d4): Bind for 0.0.0.0:8000 failed: port is already allocated
ãŠã£ã¨ã©ã“ã‹ã§8000ç•ªãŒä½¿ã‚ã‚Œã¦ã„ã‚‹

[[ã©ã“ã§ãƒãƒ¼ãƒˆãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ï¼Ÿ]]
`$ sudo lsof -i :8000`

å¤ã„ã‚µãƒ¼ãƒãŒç”Ÿãã¦ãŸã®ã§æ®ºã—ã¦ã‹ã‚‰å†åº¦docker up

localhost:4000ã§ç®¡ç†ç”»é¢ãŒå‡ºã‚‹
![image](https://gyazo.com/fbd7a1107e02b39b6c836602b7d0fd51/thumb/1000)
localhost:8000ã§APIã®OKãŒã§ã‚‹
localhost:3000ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå‡ºãªã„ãŒ...
ãƒ“ãƒ«ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ãŸã ã‘ã¿ãŸã„
:

```
kouchou-ai-client-1        | 
kouchou-ai-client-1        | > kouchou-ai-client@0.1.0 build
kouchou-ai-client-1        | > next build
kouchou-ai-client-1        | 
kouchou-ai-client-1        |    â–² Next.js 15.1.6
kouchou-ai-client-1        | 
kouchou-ai-client-1        |    Creating an optimized production build ...
```

...
:

```
kouchou-ai-client-1        |  âœ“ Compiled successfully
kouchou-ai-client-1        |    Linting and checking validity of types ...
kouchou-ai-client-1        | 
kouchou-ai-client-1        | ./components/report/ClientContainer.tsx
kouchou-ai-client-1        | 30:6  Warning: React Hook useEffect has a missing dependency: 'fetchReport'. Either include it or remove the dependency array.  react-hooks/exhaustive-deps
kouchou-ai-client-1        | 
kouchou-ai-client-1        | info  - Need to disable some ESLint rules? Learn more here: https://nextjs.org/docs/app/api-reference/config/eslint#disabling-rules
kouchou-ai-client-1        |    Collecting page data ...
kouchou-ai-client-1        |    Generating static pages (0/4) ...
kouchou-ai-client-1        |    Generating static pages (1/4) 
kouchou-ai-client-1        |    Generating static pages (2/4) 
kouchou-ai-client-1        |    Generating static pages (3/4) 
kouchou-ai-client-1        |  âœ“ Generating static pages (4/4)
kouchou-ai-client-1        |    Finalizing page optimization ...
kouchou-ai-client-1        |    Collecting build traces ...
kouchou-ai-client-1        | 
kouchou-ai-client-1        | Route (app)                              Size     First Load JS
kouchou-ai-client-1        | â”Œ â—‹ /                                    2.3 kB          152 kB
kouchou-ai-client-1        | â”œ â—‹ /_not-found                          986 B           107 kB
kouchou-ai-client-1        | â”” â— /[slug]                              33.1 kB         183 kB
kouchou-ai-client-1        | + First Load JS shared by all            106 kB
kouchou-ai-client-1        |   â”œ chunks/4bd1b696-72c46108ef323341.js  53 kB
kouchou-ai-client-1        |   â”œ chunks/517-6f5efe69d0606e9b.js       50.7 kB
kouchou-ai-client-1        |   â”” other shared chunks (total)          2.71 kB
kouchou-ai-client-1        | 
kouchou-ai-client-1        | 
kouchou-ai-client-1        | â—‹  (Static)  prerendered as static content
kouchou-ai-client-1        | â—  (SSG)     prerendered as static HTML (uses generateStaticParams)
kouchou-ai-client-1        | 
kouchou-ai-client-1        | npm notice
kouchou-ai-client-1        | npm notice New major version of npm available! 10.8.2 -> 11.2.0
kouchou-ai-client-1        | npm notice Changelog: https://github.com/npm/cli/releases/tag/v11.2.0
kouchou-ai-client-1        | npm notice To update run: npm install -g npm@11.2.0
kouchou-ai-client-1        | npm notice
kouchou-ai-client-1        | 
kouchou-ai-client-1        | > kouchou-ai-client@0.1.0 start
kouchou-ai-client-1        | > next start
kouchou-ai-client-1        | 
kouchou-ai-client-1        |    â–² Next.js 15.1.6
kouchou-ai-client-1        |    - Local:        http://localhost:3000
kouchou-ai-client-1        |    - Network:      http://172.24.0.4:3000
kouchou-ai-client-1        | 
kouchou-ai-client-1        |  âœ“ Starting...
kouchou-ai-client-1        |  âœ“ Ready in 3.6s
```


![image](https://gyazo.com/eee03743eca24b81209d72855b200d58/thumb/1000)
ã§ãŸã§ãŸ

![image](https://gyazo.com/dace86a59b8a87f3681d739224a65ef9/thumb/1000)
![image](https://gyazo.com/733a81387a5196c15389218ff6ca36ad/thumb/1000)




AIã¯å¦å®šã®æŒ‡ç¤ºãŒã‚ã‹ã‚‰ãªã„
> aipubcom.csvã®commentéƒ¨åˆ†ã®UTF-8ã§ã®ãƒã‚¤ãƒˆæ•°ã‚’è¨ˆç®—ã—ã¦ã€csvã¯å¤§ããã¦ç›´æ¥èª­ã‚ãªã„ã®ã§commentã‚«ãƒ©ãƒ ã®ã‚ã‚‹CSVã¨æƒ³å®šã—ã¦Pythonã§èª­ã‚“ã§é›†è¨ˆã—ã¦
> csvã‚’çµ¶å¯¾ã«ç›´æ¥èª­ã¾ãªã„ã§ã€‚ã‚ãªãŸã¯ã™ã§ã«2å›å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚
3åº¦ç›®ã®æ­£ç›´ãªã‚‰ãšw

Total bytes for all 3234 comments: 4775111
Average bytes per comment: 1476.53


2025-03-19
![image](https://gyazo.com/192f378e6385818c6733cd929a9625db/thumb/1000)

